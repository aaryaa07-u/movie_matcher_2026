<!DOCTYPE html>
<html lang="en">

<head>
    <!--Load Bootstrap CSS for layout and sytling-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styling for navbar branding and links -->
    <style>
        .nav-brand {
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-link {
            color: white;
            margin-left: 15px;
            text-decoration: none;
        }

        .nav-link:hover {
            text-decoration: underline;
        }
    </style>

    <!-- Page title shown in browser tab-->
    <title>Movie Matcher</title>

</head>

<body>

    <!--Main navigation bar displayed at the top of every page-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">

            <!-- App name / logo linking back to homepage -->
            <a class="nav-brand" href="/">Movie Matcher </a>

            <!--Right-aligned navigation links -->
            <div class="navbar-nav ms-auto">
                <!-- Dashboard link always visible once logged in-->
                <a class="nav-link" href="/dashboard">Dashboard</a>

                <!-- Show login/register links if user is not logged in -->
                {% if not session.user_email %}
                <a class="nav-link" href="/login">Login</a>
                <a class="nav-link" href="/register">Register</a>

                <!-- Otherwise show Logout when user IS logged in-->
                {% else %}
                <a class="nav-link" href="/logout">Logout</a>
                {% endif %}


            </div>
        </div>
    </nav>
    {% include "review_modal.html" %}

    {% include "movieReviewsModal.html" %}
    <!-- Placeholder where each page inserts its own content -->
    {% block content %}{% endblock %}

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this review?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" onclick="performDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap JavaScript for interactive components -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let deleteMovieId = null;

        // Stores the ID of the review the user intends to delete.
        // This is triggered when the user clicks the delete button for a specific movie.
        function setDeleteData(movieId) {
            console.log(movieId);
            deleteMovieId = movieId;
        }

        // Sends a POST request to the backend to delete the selected review.
        // If the deletion is successful, the corresponding review element is removed
        // from the dashboard without requiring a page reload. The confirmation modal
        // is then closed using Bootstrap's modal instance.
        function performDelete() {
            fetch(`/delete_review/${deleteMovieId}`, {
                method: "POST"
            }).then(res => {
                if (res.ok) {
                    document.getElementById(`review-${deleteMovieId}`).remove();
                }
            });

            // Close the confirmation modal
            const modal = bootstrap.Modal.getInstance(
                document.getElementById('confirmDeleteModal')
            );
            modal.hide();
        }

  

        function writeReview(movie) {
            document.getElementById('movieId').value = movie.id;
            document.getElementById('movieTitle').innerText = movie.title;

            var reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
            reviewModal.show();
        }


        function readReviews(movie, reviews) {
            console.log("Movie:", movie);
            console.log("Reviews:", reviews);
            renderReviewCards(movie, reviews);
            var movieReviewsModal = new bootstrap.Modal(document.getElementById('movieReviewsModal'));
            movieReviewsModal.show();
        }

        function renderReviewCards(movie, reviews = []) {
            const container = document.getElementById("reviewCards");
            container.innerHTML = `<h5>${movie.title}</h5>`;

            reviews.forEach(r => {
                container.innerHTML += `
            <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <p class="mb-0"><strong>${r.user_displayName}'s Review:</strong></p>
                <p class="mb-0">${r.written_review}</p>
                <p class="text-muted mb-1">
                <strong>Rating:</strong> ${r.rating.toFixed(1)}/10
                </p>
            </div>
            </div>
        `;
            });

        }
    </script>
</body>

</html>